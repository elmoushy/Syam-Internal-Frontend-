var f=Object.defineProperty;var w=(u,e,s)=>e in u?f(u,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):u[e]=s;var h=(u,e,s)=>w(u,typeof e!="symbol"?e+"":e,s);import{L as d}from"./index-uWeSuK_C.js";async function _(){try{const u=document.createElement("canvas"),e=u.getContext("2d");return e?(u.width=200,u.height=50,e.textBaseline="top",e.font="14px Arial",e.fillStyle="#f60",e.fillRect(0,0,100,50),e.fillStyle="#069",e.fillText("Browser Fingerprint",2,2),e.fillStyle="rgba(102, 204, 0, 0.7)",e.fillText("Device ID Generator",4,17),u.toDataURL()):"no-canvas"}catch{return"canvas-error"}}function S(){try{const u=document.createElement("canvas"),e=u.getContext("webgl")||u.getContext("experimental-webgl");if(!e)return"no-webgl";const s=e.getExtension("WEBGL_debug_renderer_info");if(!s)return"no-debug-info";const t=e.getParameter(s.UNMASKED_VENDOR_WEBGL),a=e.getParameter(s.UNMASKED_RENDERER_WEBGL);return`${t}~${a}`}catch{return"webgl-error"}}async function b(){const u=["monospace","sans-serif","serif"],e=["Arial","Verdana","Times New Roman","Courier New","Georgia","Palatino","Garamond","Bookman","Comic Sans MS","Trebuchet MS","Impact","Lucida Console"],s=[],a=document.createElement("canvas").getContext("2d");if(!a)return"no-canvas";const r=u.map(n=>(a.font=`12px ${n}`,a.measureText("mmmmmmmmmmlli").width));for(const n of e){let i=!1;for(let c=0;c<u.length;c++)if(a.font=`12px '${n}', ${u[c]}`,a.measureText("mmmmmmmmmmlli").width!==r[c]){i=!0;break}i&&s.push(n)}return s.join(",")}async function E(){try{const u=window.AudioContext||window.webkitAudioContext;if(!u)return"no-audio";const e=new u,s=e.createOscillator(),t=e.createAnalyser(),a=e.createGain(),r=e.createScriptProcessor(4096,1,1);return a.gain.value=0,s.type="triangle",s.connect(t),t.connect(r),r.connect(a),a.connect(e.destination),s.start(0),new Promise(n=>{r.onaudioprocess=i=>{const o=i.inputBuffer.getChannelData(0).reduce((l,p)=>l+Math.abs(p),0);s.stop(),r.disconnect(),a.disconnect(),t.disconnect(),s.disconnect(),e.close(),n(o.toString())}})}catch{return"audio-error"}}async function x(){var u,e;try{const s={canvas:await _(),webgl:S(),audio:await E(),userAgent:navigator.userAgent,language:navigator.language,languages:((u=navigator.languages)==null?void 0:u.join(","))||"",platform:navigator.platform,screen:`${screen.width}x${screen.height}x${screen.colorDepth}`,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timezoneOffset:new Date().getTimezoneOffset(),memory:navigator.deviceMemory||"unknown",cores:navigator.hardwareConcurrency||"unknown",touchSupport:navigator.maxTouchPoints||0,plugins:Array.from(navigator.plugins||[]).map(c=>c.name).join(","),fonts:await b(),colorDepth:screen.colorDepth,pixelRatio:window.devicePixelRatio||1,sessionStorage:typeof sessionStorage<"u",localStorage:typeof localStorage<"u",indexedDB:!!window.indexedDB,cpuClass:navigator.cpuClass||"unknown",doNotTrack:navigator.doNotTrack||"unknown"},t=JSON.stringify(s),a=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(t));return((e=Array.from(new Uint8Array(a)).map(c=>c.toString(16).padStart(2,"0")).join("").substring(0,12).match(/.{1,2}/g))==null?void 0:e.join(":"))||"00:00:00:00:00:00"}catch(s){return console.error("Error generating browser fingerprint:",s),m()}}function m(){var u;try{let e=localStorage.getItem("whso_device_id");return e||(e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){const t=Math.random()*16|0;return(s==="x"?t:t&3|8).toString(16)}),localStorage.setItem("whso_device_id",e)),((u=e.substring(0,12).replace(/-/g,"").match(/.{1,2}/g))==null?void 0:u.join(":"))||"00:00:00:00:00:00"}catch{return"ff:ff:ff:ff:ff:ff"}}async function g(){try{const u=localStorage.getItem("whso_device_mac");if(u)return u;const e=await x();return localStorage.setItem("whso_device_mac",e),e}catch(u){return console.error("Error getting device MAC address:",u),m()}}function y(){return{"X-Screen-Resolution":`${screen.width}x${screen.height}`,"X-Timezone":Intl.DateTimeFormat().resolvedOptions().timeZone,"X-Platform":navigator.platform,"X-User-Agent":navigator.userAgent,"X-Language":navigator.language}}class k{constructor(){h(this,"baseURL","/surveys/")}async apiCall(e,s={}){var a,r,n;const t=`${this.baseURL}${e}`;try{let i;const c=s.method||"GET";if(c==="GET")i=await d.get(t);else if(c==="POST"){const o=s.body?JSON.parse(s.body):{};i=await d.post(t,o)}else if(c==="PATCH"){const o=s.body?JSON.parse(s.body):{};i=await d.patch(t,o)}else if(c==="DELETE")i=await d.delete(t);else throw new Error(`Unsupported method: ${c}`);return i.data&&typeof i.data=="object"?"status"in i.data&&"data"in i.data?i.data:{status:"success",message:"Data retrieved successfully",data:i.data}:i.data}catch(i){throw(r=(a=i.response)==null?void 0:a.data)!=null&&r.message?new Error(i.response.data.message):new Error(i.message||`HTTP error! status: ${(n=i.response)==null?void 0:n.status}`)}}async getAllSurveys(e){var a,r,n,i;const s=new URLSearchParams;e&&Object.entries(e).forEach(([c,o])=>{o!=null&&o!==""&&s.append(c,o.toString())});const t=`surveys${s.toString()?`?${s.toString()}`:""}`;try{const c=await d.get(`${this.baseURL}${t}`),o=((a=c.data)==null?void 0:a.data)||c.data;if(o&&"results"in o)return{count:o.count||0,total_pages:o.total_pages||0,current_page:o.current_page||1,per_page:o.per_page||10,next:o.next||null,previous:o.previous||null,results:o.results||[],applied_filters:((r=c.data)==null?void 0:r.applied_filters)||o.applied_filters||{},available_filters:o.available_filters||{}};if(((n=c.data)==null?void 0:n.status)==="success"&&((i=c.data)!=null&&i.data)){const l=c.data.data;return{count:l.count||0,total_pages:l.total_pages||0,current_page:l.current_page||1,per_page:l.per_page||10,next:l.next||null,previous:l.previous||null,results:l.results||[],applied_filters:c.data.applied_filters||{},available_filters:l.available_filters||{}}}return{count:0,total_pages:0,current_page:1,per_page:10,next:null,previous:null,results:[]}}catch(c){return console.error("API Error:",c),{count:0,total_pages:0,current_page:1,per_page:10,next:null,previous:null,results:[]}}}async getSurvey(e){return this.apiCall(`surveys/${e}/`)}async createSurvey(e){return this.apiCall("surveys/",{method:"POST",body:JSON.stringify(e)})}async createDraft(e){const s={...e,per_device_access:!1};return this.apiCall("draft/",{method:"POST",body:JSON.stringify(s)})}async submitSurvey(e){return this.apiCall("submit/",{method:"POST",body:JSON.stringify({survey_id:e})})}async updateSurvey(e,s){if(!e||e==="undefined"||e==="null")throw new Error("Survey ID is required and cannot be undefined");const t={...s};if("access_level"in t){switch(t.access_level){case"public":t.visibility="PUBLIC";break;case"authenticated":t.visibility="AUTH";break;case"private":t.visibility="PRIVATE";break}delete t.access_level}const a=await d.patch(`/surveys/surveys/${e}/`,t);if(a.data.status==="success")return{data:a.data.data,message:a.data.message,status:a.data.status};throw new Error(a.data.message||"Failed to update survey")}async updateSurveyAccess(e,s,t,a){if(!e||e==="undefined"||e==="null")throw new Error("Survey ID is required and cannot be undefined");let r;switch(s){case"public":r="PUBLIC";break;case"authenticated":r="AUTH";break;case"private":r="PRIVATE";break;case"groups":r="GROUPS";break;default:r="PRIVATE"}const n={visibility:r};return r==="PUBLIC"&&a===!0?n.per_device_access=!0:r==="PUBLIC"&&t&&a!==!0&&(n.public_contact_method=t),this.updateSurvey(e,n)}async deleteSurvey(e){await this.apiCall(`surveys/${e}/`,{method:"DELETE"})}async cloneSurvey(e){return this.apiCall(`surveys/${e}/clone/`,{method:"POST"})}async setSurveyAudience(e,s){return this.apiCall(`surveys/${e}/audience/`,{method:"POST",body:JSON.stringify(s)})}async generatePublicLink(e,s={}){const t=await d.get(`/surveys/surveys/${e}/public-link/`);if(t.data.status==="success")return{data:{link:`https://whso.gov.ae:5173/survey/public/${t.data.data.token}`,token:t.data.data.token,expires_at:t.data.data.expires_at},message:t.data.message,status:t.data.status};throw new Error(t.data.message||"Failed to generate public link")}async getPublicLink(e){var s;try{const t=await d.get(`/surveys/surveys/${e}/public-link/`);return t.data.status==="success"&&t.data.data?{data:{link:`https://whso.gov.ae:5173/survey/public/${t.data.data.token}`,token:t.data.data.token,expires_at:t.data.data.expires_at},message:t.data.message,status:t.data.status}:{data:null,message:t.data.message||"No public link found",status:t.data.status||"success"}}catch(t){if(((s=t.response)==null?void 0:s.status)===404)return{data:null,message:"No public link found",status:"success"};throw t}}async revokePublicLink(e){const s=await d.delete(`/surveys/surveys/${e}/public-link/`);if(s.data.status==="success")return{data:{message:s.data.message},message:s.data.message,status:s.data.status};throw new Error(s.data.message||"Failed to revoke public link")}async getCurrentLink(e){const s=await d.get(`/surveys/surveys/${e}/current-link/`);if(s.data.status==="success"){const a={...s.data.data,link:`https://whso.gov.ae:5173/survey/public/${s.data.data.token}`};return{status:s.data.status,message:s.data.message,data:a}}else throw new Error(s.data.message||"Failed to get current link")}async generatePasswordProtectedLink(e,s={}){const t={days_to_expire:s.days_to_expire||30};s.email&&(t.email=s.email),s.phone&&(t.phone=s.phone),s.restricted_email&&s.restricted_email.length>0&&(t.restricted_email=s.restricted_email),s.restricted_phone&&s.restricted_phone.length>0&&(t.restricted_phone=s.restricted_phone);const a=await d.post(`/surveys/surveys/${e}/generate-password-link/`,t);if(a.data.status==="success"){const n=`https://whso.gov.ae:5173/survey/password/${a.data.data.token}`;return{data:{token:a.data.data.token,password:a.data.data.password,expires_at:a.data.data.expires_at,is_password_protected:a.data.data.is_password_protected,is_contact_restricted:a.data.data.is_contact_restricted,restricted_email:a.data.data.restricted_email,restricted_phone:a.data.data.restricted_phone,link:n},message:a.data.message,status:a.data.status}}else throw new Error(a.data.message||"Failed to generate password-protected link")}async accessPasswordProtectedSurvey(e,s,t){const a=await d.post(`/surveys/password-surveys/${e}/`,{password:t.password,email:t.email,phone:t.phone},{headers:{Authorization:`Bearer ${s}`}});if(a.data.status==="success")return{data:a.data.survey_details,message:a.data.message,status:a.data.status};throw new Error(a.data.message||"Failed to access password-protected survey")}async validatePasswordAccessByToken(e,s){const t=await d.post(`/surveys/password-access/${e}/`,{password:s.password,email:s.email,phone:s.phone});if(t.data.status==="success")return{data:t.data.data,message:t.data.message,status:t.data.status};throw new Error(t.data.message||"Failed to access password-protected survey")}async getPasswordProtectedSurvey(e,s,t){const a=await d.post(`/surveys/password-surveys/${e}/`,{password:t},{headers:{Authorization:`Bearer ${s}`}});if(a.data.status==="success")return{data:a.data.data,message:a.data.message,status:a.data.status};throw new Error(a.data.message||"Failed to fetch password-protected survey")}async submitPasswordProtectedResponse(e){const s=await g(),t=y(),a=await d.post("/surveys/password-responses/",e,{headers:{"X-Mac-Address":s,...t}});if(a.data.status==="success")return{data:{response_id:a.data.data.response_id,survey_id:a.data.data.survey_id,submitted_at:a.data.data.submitted_at,answers_count:a.data.data.answers_count,access_method:"password_token"},message:a.data.message,status:a.data.status};throw new Error(a.data.message||"Failed to submit password-protected response")}async searchUsers(e){var t;if(e.length<2)return{data:{users:[],total:0},message:"Query too short",status:"success"};const s=await d.get("/surveys/users/search/",{params:{query:e}});if(s.data.status==="success")return{data:{users:s.data.data.users||[],total:((t=s.data.data.users)==null?void 0:t.length)||0},message:s.data.message,status:s.data.status};throw new Error(s.data.message||"Failed to search users")}async getMyAdminGroups(){const e=await d.get("/surveys/my-admin-groups/");if(e.data.success||e.data.status==="success")return{data:e.data.data,message:e.data.message,status:"success"};throw new Error(e.data.message||"Failed to get admin groups")}async getAllUsers(e=50){const s=new URLSearchParams({limit:e.toString()});return this.apiCall(`users?${s.toString()}`)}async shareSurvey(e,s){const t=await d.post(`/surveys/surveys/${e}/share/`,s);if(t.data.status==="success")return{data:{shared_users:t.data.data.shared_users,total_shared:t.data.data.total_shared},message:t.data.message,status:t.data.status};throw new Error(t.data.message||"Failed to share survey")}async getSharedUsers(e){return this.apiCall(`surveys/${e}/shared-users/`)}async removeSharedUser(e,s){return this.apiCall(`surveys/${e}/shared-users/${s}/`,{method:"DELETE"})}async validateAccess(e){const s={token:e},t=await d.get("/surveys/surveys/access/",{params:s});if(t.data.status==="success")return{data:{has_access:t.data.data.has_access,survey:t.data.data.survey},message:t.data.message,status:t.data.status};throw new Error(t.data.message||"Failed to validate access")}async submitAnonymousResponse(e){var s;try{const t=await g(),a=y(),r=await d.post("/surveys/responses/",e,{headers:{"X-Mac-Address":t,...a}});if(r.data.status==="success")return{data:r.data.data,message:r.data.message,status:r.data.status};throw new Error(r.data.message||"Failed to submit survey response")}catch(t){if(t instanceof Error&&((s=t.response)!=null&&s.data)){const a=t.response.data;if(a.status==="error")throw new Error(a.message||"Failed to submit survey response")}throw t instanceof Error?t:new Error("Failed to submit survey response")}}async submitAuthenticatedResponse(e){var s;try{const t=await g(),a=y(),r=await d.post("/surveys/auth-responses/",e,{headers:{"X-Mac-Address":t,...a}});if(r.data.status==="success")return{data:r.data.data,message:r.data.message,status:r.data.status};throw new Error(r.data.message||"Failed to submit survey response")}catch(t){if(t instanceof Error&&((s=t.response)!=null&&s.data)){const a=t.response.data;if(a.status==="error")throw new Error(a.message||"Failed to submit survey response")}throw t instanceof Error?t:new Error("Failed to submit survey response")}}async submitSurveyResponse(e){var s;try{const{token:t,...a}=e,r=await d.post("/surveys/responses/",a);if(r.data.status==="success")return{data:{message:r.data.message},message:r.data.message,status:r.data.status};throw new Error(r.data.message||"Failed to submit survey response")}catch(t){if(t instanceof Error&&((s=t.response)!=null&&s.data)){const a=t.response.data;if(a.status==="error")throw new Error(a.message||"Failed to submit survey response")}throw t instanceof Error?t:new Error("Failed to submit survey response")}}async getPublicSurvey(e,s){const t=new URLSearchParams({token:s});return this.apiCall(`surveys/${e}/public?${t.toString()}`)}async addQuestion(e,s){return this.apiCall(`surveys/${e}/questions/`,{method:"POST",body:JSON.stringify(s)})}async updateQuestion(e,s,t){return this.apiCall(`surveys/${e}/questions/${s}/`,{method:"PATCH",body:JSON.stringify(t)})}async deleteQuestion(e,s){await this.apiCall(`surveys/${e}/questions/${s}/`,{method:"DELETE"})}async getSurveyResponses(e,s){const t=new URLSearchParams;s&&Object.entries(s).forEach(([r,n])=>{n!=null&&t.append(r,n.toString())});const a=`surveys/${e}/responses${t.toString()?`?${t.toString()}`:""}`;return this.apiCall(a)}async getAnalyticsDashboard(){try{const e=await this.getAllSurveys(),s=(e==null?void 0:e.results)||[];return{status:"success",message:"Analytics retrieved successfully",data:{total_surveys:s.length,active_surveys:s.filter(a=>a==null?void 0:a.is_active).length,total_responses:s.reduce((a,r)=>a+((r==null?void 0:r.response_count)||0),0),avg_response_rate:.75,recent_activity:{new_surveys_this_week:0,new_responses_this_week:0},top_surveys:s.filter(a=>a&&a.id&&a.title).sort((a,r)=>((r==null?void 0:r.response_count)||0)-((a==null?void 0:a.response_count)||0)).slice(0,5).map(a=>({id:a.id,title:a.title,response_count:a.response_count||0,completion_rate:.85}))}}}catch{return{status:"success",message:"Analytics retrieved with fallback data",data:{total_surveys:0,active_surveys:0,total_responses:0,avg_response_rate:0,recent_activity:{new_surveys_this_week:0,new_responses_this_week:0},top_surveys:[]}}}}async getQuestionAnalytics(e,s,t){const a=new URLSearchParams;t!=null&&t.start_date&&a.append("start_date",t.start_date),t!=null&&t.end_date&&a.append("end_date",t.end_date),t!=null&&t.include_demographics&&a.append("include_demographics","true");const r=a.toString(),n=`surveys/${e}/analytics/questions/${s}/${r?"?"+r:""}`;return this.apiCall(n)}async exportSurveyData(e,s={format:"csv",include_personal_data:!1}){const t=new URLSearchParams;s.format&&t.append("format",s.format),s.include_personal_data!==void 0&&t.append("include_personal_data",s.include_personal_data.toString());const a=t.toString(),r=`/surveys/surveys/${e}/export/${a?`?${a}`:""}`;try{return(await d.get(r,{responseType:"blob"})).data}catch(n){throw new Error(`Export failed: ${n.message}`)}}async performBulkOperation(e){return this.apiCall("bulk-operations/",{method:"POST",body:JSON.stringify(e)})}async searchSurveys(e){return this.getAllSurveys({search:e})}async getSurveysByVisibility(e){return this.getAllSurveys({visibility:e})}async getActiveSurveys(){return this.getAllSurveys({is_active:!0})}async getInactiveSurveys(){return this.getAllSurveys({is_active:!1})}downloadFile(e,s){const t=window.URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download=s,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(t)}validateSurveyData(e){const s=[];return(!e.title||e.title.trim().length===0)&&s.push("Survey title is required"),e.title&&e.title.length>200&&s.push("Survey title must be less than 200 characters"),e.description&&e.description.length>1e3&&s.push("Survey description must be less than 1000 characters"),s}validateQuestionData(e){const s=[];if((!e.text||e.text.trim().length===0)&&s.push("Question text is required"),e.text&&e.text.length>500&&s.push("Question text must be less than 500 characters"),["single_choice","multiple_choice"].includes(e.question_type))if(!e.options)s.push("Options are required for choice questions");else try{const t=JSON.parse(e.options);(!Array.isArray(t)||t.length<2)&&s.push("Choice questions must have at least 2 options")}catch{s.push("Options must be a valid JSON array")}return s}async getTokenAccessibleSurveys(e){var s,t,a,r,n,i,c;try{const o=await d.get("/surveys/token/surveys/",{headers:{Authorization:`Bearer ${e}`}});return o.data&&typeof o.data=="object"?"success"in o.data&&"data"in o.data?{status:"success",message:o.data.message||"Token-accessible surveys retrieved successfully",data:o.data.data}:{status:"success",message:"Token-accessible surveys retrieved successfully",data:o.data}:o.data}catch(o){throw((s=o.response)==null?void 0:s.status)===401?(a=(t=o.response.data)==null?void 0:t.message)!=null&&a.includes("expired")?new Error("Token has expired"):(n=(r=o.response.data)==null?void 0:r.message)!=null&&n.includes("inactive")?new Error("Associated survey is not active"):new Error("Invalid token"):new Error(((c=(i=o.response)==null?void 0:i.data)==null?void 0:c.message)||o.message||"Failed to retrieve surveys")}}async getMySharedSurveys(e){const s=new URLSearchParams;e&&Object.entries(e).forEach(([r,n])=>{n!=null&&s.append(r,n.toString())});const t=`my-shared${s.toString()?`?${s.toString()}`:""}`,a=await d.get(`${this.baseURL}${t}`);return a.data&&"count"in a.data&&"results"in a.data||a.data&&"status"in a.data&&a.data.status==="success"?a.data:{status:"success",message:"Shared surveys retrieved successfully",data:a.data}}async getAuthSurvey(e){var s,t,a,r,n;try{return{status:"success",message:"Survey retrieved successfully",data:(await d.get(`/surveys/surveys/${e}/auth-access/`)).data.data}}catch(i){throw((s=i.response)==null?void 0:s.status)===401?new Error("Authentication required to access this survey"):((t=i.response)==null?void 0:t.status)===403?new Error("Access denied to this survey"):((a=i.response)==null?void 0:a.status)===404?new Error("Survey not found or not available"):new Error(((n=(r=i.response)==null?void 0:r.data)==null?void 0:n.message)||i.message||"Failed to load survey")}}async submitAuthResponse(e){var s,t,a,r,n,i,c,o,l;try{const p=await g(),v=y();return{status:"success",message:"Response submitted successfully",data:(await d.post("/surveys/auth-responses/",e,{headers:{"X-Mac-Address":p,...v}})).data.data}}catch(p){throw((s=p.response)==null?void 0:s.status)===400?new Error(((a=(t=p.response)==null?void 0:t.data)==null?void 0:a.message)||"Invalid request data"):((r=p.response)==null?void 0:r.status)===401?new Error("Authentication required to submit response"):((n=p.response)==null?void 0:n.status)===403?new Error("Access denied to this survey"):((i=p.response)==null?void 0:i.status)===404?new Error("Survey not found"):((c=p.response)==null?void 0:c.status)===409?new Error("لقد قمت بتقديم إجابة لهذا الاستطلاع من قبل"):new Error(((l=(o=p.response)==null?void 0:o.data)==null?void 0:l.message)||p.message||"Failed to submit response")}}}const C=new k;export{C as s};
